- name: botソースコードを同期 (確実なcopy版)
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../"
    dest: "{{ ansible_facts['env']['HOME'] }}/rodep-lore/"
    mode: '0755'
    # ディレクトリごと送る際、.gitなどは送りたくないので
    # 本来なら synchronize の専売特許ですが、今回は一旦全部送ります
  become: true

- name: startup.sh に実行権限を付与
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/rodep-lore/bot/startup.sh"
    mode: "0755"
    state: file
  become: true

- name: systemd ユニットファイルを動的に作成して配置
  ansible.builtin.template:
    src: templates/bot.service.j2
    dest: /etc/systemd/system/bot.service
    mode: "0644"
  become: true

- name: systemdをリロードしてbot.serviceを有効化
  ansible.builtin.systemd:
    name: bot.service
    enabled: yes
    daemon_reload: yes
  become: true
  # テストコンテナ(systemdなし)では失敗するので、実機のみで動くようにする
  when: inventory_hostname != 'localhost'
